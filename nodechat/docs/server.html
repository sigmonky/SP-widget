<!DOCTYPE html>  <html> <head>   <title>server.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>nodechat.js
Copyright(c) 2011 Justin Slattery <a href="&#109;&#x61;&#x69;&#x6C;&#x74;&#111;:&#106;&#x75;&#x73;&#x74;&#x69;&#110;&#x2E;&#115;&#x6C;&#97;&#116;&#x74;&#101;ry&#64;&#x66;&#x7A;&#121;&#115;&#113;&#114;&#46;&#99;&#x6F;&#109;">&#106;&#x75;&#x73;&#x74;&#x69;&#110;&#x2E;&#115;&#x6C;&#97;&#116;&#x74;&#101;ry&#64;&#x66;&#x7A;&#121;&#115;&#113;&#114;&#46;&#99;&#x6F;&#109;</a> 
MIT Licensed</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Global settings</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">dev_port</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">server_port</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">config_file</span> <span class="o">=</span> <span class="s1">&#39;/home/node/nodechat_config&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Include core dependencies.  </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">).</span><span class="nx">_</span>
    <span class="p">,</span> <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;backbone&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Include and configure winston for logging.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">winston</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;winston&#39;</span><span class="p">);</span>
<span class="nx">winston</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">winston</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">File</span><span class="p">,</span> <span class="p">{</span> <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;nodechat.log&#39;</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Include our own modules</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./models/models&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/auth&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">mashlib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/mashlib&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">ncutils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/ncutils&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Require redis and setup the client </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">rc</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">();</span>

<span class="nx">redis</span><span class="p">.</span><span class="nx">debug_mode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="nx">rc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Error &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Setup connect, express, socket, and the connect-redis session store</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">()</span>
    <span class="p">,</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">jade</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jade&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">stylus</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stylus&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">RedisStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect-redis&#39;</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view engine&#39;</span><span class="p">,</span> <span class="s1">&#39;jade&#39;</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view options&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">layout</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span> <span class="nx">store</span><span class="o">:</span> <span class="k">new</span> <span class="nx">RedisStore</span><span class="p">(),</span> <span class="nx">secret</span><span class="o">:</span> <span class="s1">&#39;Secretly I am an elephant&#39;</span> <span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">&#39;./public&#39;</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">stylus</span><span class="p">.</span><span class="nx">middleware</span><span class="p">({</span>
    <span class="nx">src</span><span class="o">:</span> <span class="s1">&#39;./views&#39;</span>
  <span class="p">,</span> <span class="nx">dest</span><span class="o">:</span> <span class="s1">&#39;./public&#39;</span>
<span class="p">}));</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>setup stylus</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stylus</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;compress&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Middleware that decides what a valid login looks like. In this case, just verify that we have a session object for the user.</p>

<p>This is an express <a href="http://expressjs.com/guide.html#route-middleware">route middleware</a>. Control is passed to the middleware function before the route function is called. We use restrictAccess() to verify that we have a valid user key in the session, implying that authentication has succeeded, before we send the client to the index.jade template. If we do not have a valid user in the session, then we redirect to the '/login' route. This effectively locks down our '/' route from unauthenticated access. You could add the restrictAccess() all to any route you want to protect.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">restrict</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;Access denied!&#39;</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Tell connect to destory the session.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>destroy the user's session to log them out
will be re-created next request</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Route: GET /login</p>

<p>Template: login.jade </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;GET /login&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Route: POST /login</p>

<p>Calls the authentication module to verify login details. Failures are redirected back to the login page.</p>

<p>If the authentication module gives us a user object back, we ask connect to regenerate the session and send the client back to index. Note: we specify a <em>long</em> cookie age so users won't have to log in frequently. We also set the httpOnly flag to false (I know, not so secure) to make the cookie available over <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/net/Socket.html">Flash Sockets</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Regenerate session when signing in
to prevent fixation </p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">regenerate</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Store the user's primary key 
in the session store to be retrieved,
or in this case the entire user object</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;regenerated session id &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">maxAge</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">//Force longer cookie age</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">httpOnly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">hashpass</span> <span class="o">||</span> <span class="s1">&#39;No Hash&#39;</span><span class="p">;</span>

                <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Storing new hash for user &#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">hash</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;Authentication failed, please check your username and password.&#39;</span><span class="p">;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;back&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Serve up any static file requested by the client</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/.(js|css)&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">sendfile</span><span class="p">(</span><span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>create local state</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">nodeChatModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">NodeChatModel</span><span class="p">();</span>

<span class="nx">rc</span><span class="p">.</span><span class="nx">lrange</span><span class="p">(</span><span class="s1">&#39;chatentries&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jsonChat</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">chat</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">ChatEntry</span><span class="p">();</span>
                <span class="nx">chat</span><span class="p">.</span><span class="nx">mport</span><span class="p">(</span><span class="nx">jsonChat</span><span class="p">);</span>
                <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">chat</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Failed to revive chat &#39;</span> <span class="o">+</span> <span class="nx">jsonChat</span> <span class="o">+</span> <span class="s1">&#39; with err &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Revived &#39;</span> <span class="o">+</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; chats&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;No data returned for key&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>


<span class="nx">rc</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s1">&#39;mashtags&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;SMEMBERS for key mashtags failed with error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jsonMashTag</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">mashTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">MashTagModel</span><span class="p">();</span>
                <span class="nx">mashTag</span><span class="p">.</span><span class="nx">mport</span><span class="p">(</span><span class="nx">jsonMashTag</span><span class="p">);</span>
                <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">globalMashTags</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">mashTag</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Failed to revive mashTag &#39;</span> <span class="o">+</span> <span class="nx">jsonMashTag</span> <span class="o">+</span> <span class="s1">&#39; with err &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Revived &#39;</span> <span class="o">+</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">globalMashTags</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; mashtags&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;SMEMBERS for key mashtags returned no data&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>When we have a client that shouldn't be connected, <strong>kick 'em off!</strong>' </p>

<ul>
<li>@param {object} client</li>
<li>@param {function} fn</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">disconnectAndRedirectClient</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Disconnecting unauthenticated user&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;disconnect&#39;</span> <span class="p">});</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="nx">fn</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Helper function to send tags to a user</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">sendMashTagsToUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">clientList</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;mashtag&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Event handler for client disconnects. Simply broadcasts the new active client count.</p>

<ul>
<li>@param {object} client</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">clientDisconnect</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Client disconnecting: &#39;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">);</span>

    <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getConnectedUser</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cleanName</span><span class="p">,</span> <span class="nx">connectedUser</span><span class="p">,</span> <span class="nx">rKey</span><span class="p">,</span> <span class="nx">sUser</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span> <span class="o">||</span> <span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">user</span> <span class="o">||</span> <span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] called with null data, data.user or data.user.name&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">cleanName</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span><span class="p">);</span>

    <span class="nx">connectedUser</span> <span class="o">=</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">cleanName</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">connectedUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connectedUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span><span class="s1">&#39;client&#39;</span><span class="o">:</span> <span class="nx">client</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span> <span class="nx">cleanName</span><span class="p">});</span>
        <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">clientList</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">clientList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>

        <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">connectedUser</span><span class="p">);</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] new user: &#39;</span> <span class="o">+</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; on client: &#39;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">);</span>
    
        <span class="nx">sUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)});</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({</span>
            <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;user:add&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">sUser</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Grab mashtag subscriptions for user</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">rKey</span> <span class="o">=</span> <span class="s1">&#39;user:&#39;</span> <span class="o">+</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mashtags&#39;</span><span class="p">;</span>
        <span class="nx">rc</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="nx">rKey</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Error retrieving &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> 
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tagId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Try and find the tag in the current active list</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">mashTag</span> <span class="o">=</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">globalMashTags</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">tagId</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>If not found, create it and add it to the global list</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] tried to add invalid tag to user subscription&#39;</span><span class="p">);</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">mashTag</span><span class="p">.</span><span class="nx">watchingUsers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">connectedUser</span><span class="p">);</span>
                        <span class="nx">sendMashTagsToUser</span><span class="p">(</span><span class="nx">connectedUser</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">);</span>
                        <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">followedMashTags</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">mashTag</span><span class="p">);</span>

                        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] mashtag with id: &#39;</span> <span class="o">+</span> <span class="nx">tagId</span> <span class="o">+</span> <span class="s1">&#39; revived for user: &#39;</span> <span class="o">+</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] Failed to revive mashtag with key &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; with id &#39;</span> <span class="o">+</span> <span class="nx">tagId</span> <span class="o">+</span> <span class="s1">&#39; with err &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>

                <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] Revived &#39;</span> <span class="o">+</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; chats&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] No data returned for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Count multiple connections in case someone has a window open</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Set disconnect here so we can destroy the user model</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> 
            <span class="nx">clientDisconnect</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span><span class="o">--</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Removing user from active pool: &#39;</span> <span class="o">+</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
                    <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                    <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">followedMashTags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Unsubscribping user: &#39;</span> <span class="o">+</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; from mashtag: &#39;</span> <span class="o">+</span> <span class="nx">t</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
                        <span class="nx">t</span><span class="p">.</span><span class="nx">watchingUsers</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">connectedUser</span><span class="p">);</span>
                    <span class="p">});</span>

                    <span class="nx">sUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)});</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({</span>
                        <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;user:remove&#39;</span><span class="p">,</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="nx">sUser</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
                    <span class="p">});</span>

                    <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">connectedUser</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span> </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Looks like the user has a new session for some reason. try and deal with this</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">connectedUser</span><span class="p">.</span><span class="nx">clientList</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">return</span> <span class="nx">c</span> <span class="o">===</span> <span class="nx">client</span><span class="p">;</span> 
    <span class="p">}))</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[getConnectedUser] existing user: &#39;</span> <span class="o">+</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; on new client: &#39;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">);</span>
        <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span><span class="o">++</span><span class="p">;</span>
        <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">clientList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Set disconnect here so we can destroy the user model</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> 
            <span class="nx">clientDisconnect</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span><span class="o">--</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Removing user from active pool: &#39;</span> <span class="o">+</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
                    <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">currentConnections</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="nx">sUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)});</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({</span>
                        <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;user:remove&#39;</span><span class="p">,</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="nx">sUser</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
                    <span class="p">});</span>

                    <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">connectedUser</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">connectedUser</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getDirectsFromString</span><span class="p">(</span><span class="nx">chatText</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">directIndex</span><span class="p">,</span> <span class="nx">direct</span><span class="p">,</span> <span class="nx">endPos</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">chatText</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">directIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">directIndex</span> <span class="o">=</span> <span class="nx">chatText</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39; @&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">directIndex</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">chatText</span><span class="p">[</span><span class="nx">directIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39; &#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">endPos</span> <span class="o">=</span> <span class="nx">chatText</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nx">directIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">direct</span> <span class="o">=</span> <span class="nx">chatText</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">directIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">endPos</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Found direct: &#39;</span> <span class="o">+</span> <span class="nx">direct</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">direct</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">handleDirects</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">originalUser</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">direct</span><span class="p">,</span> <span class="nx">foundUser</span><span class="p">;</span>
    <span class="nx">direct</span> <span class="o">=</span> <span class="nx">getDirectsFromString</span><span class="p">(</span><span class="nx">chat</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">direct</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;looking for direct targer user &#39;</span> <span class="o">+</span> <span class="nx">direct</span><span class="p">);</span>
        <span class="nx">foundUser</span> <span class="o">=</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="nx">direct</span><span class="p">;</span>
        <span class="p">});</span>
        
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;found user is &#39;</span> <span class="o">+</span> <span class="nx">foundUser</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">foundUser</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Located direct targer user&#39;</span> <span class="o">+</span> <span class="nx">foundUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
            <span class="nx">foundUser</span><span class="p">.</span><span class="nx">directs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">chat</span><span class="p">);</span>

            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">foundUser</span><span class="p">.</span><span class="nx">clientList</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span> 
                <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
                    <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;direct&#39;</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">()</span>
                <span class="p">});</span>
            <span class="p">});</span>

            <span class="nx">rc</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;user:&#39;</span> <span class="o">+</span> <span class="nx">foundUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.directs&#39;</span><span class="p">,</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">}),</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Send back to the original user</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">originalUser</span><span class="p">.</span><span class="nx">clientList</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span> 
                <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
                    <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;direct&#39;</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">()</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Helper function to remove tag subscription for a user</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">deleteMashtagForUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rKey</span> <span class="o">=</span> <span class="s1">&#39;user:&#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mashtags&#39;</span><span class="p">;</span>

    <span class="nx">rc</span><span class="p">.</span><span class="nx">srem</span><span class="p">(</span><span class="nx">rKey</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;SREM failed for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span> <span class="o">+</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;SREM succeeded for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span> <span class="o">+</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span> 
            <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;SREM could not find value for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span> <span class="o">+</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Look for unsubscription notifications</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">checkForMashTagUnSub</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mashTagsToRemove</span><span class="p">,</span> <span class="nx">foundTag</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">makeTagFindHandler</span><span class="p">,</span> <span class="nx">makeClientUnSubNotifyHandler</span><span class="p">;</span>

    <span class="nx">makeTagFindHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">tagName</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">makeClientUnSubNotifyHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;notified client &#39;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">);</span> 
            <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
                <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;mashtag:delete&#39;</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
            <span class="p">});</span>
        <span class="p">};</span> 
    <span class="p">};</span>

    <span class="nx">mashTagsToRemove</span> <span class="o">=</span> <span class="nx">mashlib</span><span class="p">.</span><span class="nx">getChunksFromString</span><span class="p">(</span><span class="nx">chat</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">),</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mashTagsToRemove</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>TODO remove for loop</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">t</span> <span class="k">in</span> <span class="nx">mashTagsToRemove</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">foundTag</span> <span class="o">=</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">globalMashTags</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">makeTagFindHandler</span><span class="p">(</span><span class="nx">mashTagsToRemove</span><span class="p">[</span><span class="nx">t</span><span class="p">]));</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Try and remove it from redis whether we found it or not, in case of sync issues</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">deleteMashtagForUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">mashTagsToRemove</span><span class="p">[</span><span class="nx">t</span><span class="p">]);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">foundTag</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">foundTag</span><span class="p">.</span><span class="nx">watchingUsers</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Notify client that tag was unsub'd</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">clientList</span><span class="p">,</span> <span class="nx">makeClientUnSubNotifyHandler</span><span class="p">(</span><span class="nx">foundTag</span><span class="p">));</span> 
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">topPoster</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">topPoster</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;noone&#39;</span><span class="p">;</span>
<span class="nx">topPoster</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">topPoster</span><span class="p">.</span><span class="nx">lettercount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Event handler for new chat messages. Stores the chat in redis and broadcasts it to all connected clients.</p>

<ul>
<li>@param {object} client</li>
<li>@param {object} socket</li>
<li>@param {json string} msg</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">message</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">rediskey</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;received from client: &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">rediskey</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;clientauthrequest&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;clientauthrequest received with hash &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">chat</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">ChatEntry</span><span class="p">();</span>
        <span class="nx">chat</span><span class="p">.</span><span class="nx">mport</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">connectSession</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">cleanChat</span><span class="p">,</span> <span class="nx">connectedUser</span><span class="p">,</span> <span class="nx">userName</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">disconnectAndRedirectClient</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[message] Error on connectSession: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">connectedUser</span> <span class="o">=</span> <span class="nx">getConnectedUser</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">client</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">connectedUser</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">disconnectAndRedirectClient</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[message] connectedUser is null or empty&#39;</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">cleanChat</span> <span class="o">=</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cleanChat</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">cleanChat</span> <span class="o">=</span> <span class="nx">cleanChat</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">userName</span> <span class="o">=</span> <span class="nx">connectedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
            <span class="nx">chat</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="o">:</span> <span class="nx">userName</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="o">:</span> <span class="nx">cleanChat</span><span class="p">});</span>

            <span class="nx">rc</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;userban:&#39;</span> <span class="o">+</span> <span class="nx">userName</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">udata</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
                    <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> 
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">udata</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Banned: &#39;</span> <span class="o">+</span> <span class="nx">udata</span><span class="p">);</span> 
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">topPoster</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">userName</span> <span class="o">&amp;&amp;</span> <span class="nx">userName</span> <span class="o">!==</span> <span class="s1">&#39;jslatts&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">topPoster</span><span class="p">.</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="nx">topPoster</span><span class="p">.</span><span class="nx">lettercount</span> <span class="o">&gt;</span> <span class="mi">700</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span><span class="p">;</span> 
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>set a timer to reset this</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">topPoster</span><span class="p">.</span><span class="nx">timeOut</span><span class="p">);</span>
                            <span class="nx">topPoster</span><span class="p">.</span><span class="nx">timeOut</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                                <span class="nx">topPoster</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                            <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>

                            <span class="nx">topPoster</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
                            <span class="nx">topPoster</span><span class="p">.</span><span class="nx">lettercount</span> <span class="o">+=</span> <span class="nx">cleanChat</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">topPoster</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">userName</span><span class="p">;</span>
                        <span class="nx">topPoster</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="nx">topPoster</span><span class="p">.</span><span class="nx">lettercount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">chat</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">rc</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s1">&#39;next.chatentry.id&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newId</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">chat</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">newId</span><span class="p">,</span> <span class="nx">time</span><span class="o">:</span> <span class="nx">ncutils</span><span class="p">.</span><span class="nx">getClockTime</span><span class="p">(),</span> <span class="nx">datetime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()});</span>
                        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">());</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>If we have hashes, deal with them</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="kd">var</span> <span class="nx">shouldBroadcast</span> <span class="o">=</span> <span class="nx">handleDirects</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">connectedUser</span><span class="p">);</span> 
                        <span class="nx">shouldBroadcast</span> <span class="o">=</span> <span class="nx">shouldBroadcast</span> <span class="o">&amp;&amp;</span> <span class="nx">checkForMashTagUnSub</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">connectedUser</span><span class="p">);</span> 

                        <span class="k">if</span> <span class="p">(</span><span class="nx">shouldBroadcast</span><span class="p">)</span>
                            <span class="nx">shouldBroadcast</span> <span class="o">=</span> <span class="nx">shouldBroadcast</span> <span class="o">&amp;&amp;</span> <span class="nx">handleMashTags</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">connectedUser</span><span class="p">);</span> 

                        <span class="k">if</span> <span class="p">(</span><span class="nx">shouldBroadcast</span><span class="p">)</span>
                            <span class="nx">broadcastChat</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span><span class="nx">client</span><span class="p">);</span>
                    <span class="p">});</span> 
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Handle the new connection event for socket. </p>

<p>connectSession() is a helper method that will verify a client's validity by checking for a cookie in the request header, then, if we find it,  <em>pulling their session out of redis</em>. </p>

<p>We then use the helper method in the 'connection' handler for our socket listener. Instead accepting any user connection, we are going to check that the client has a valid session (meaning they logged in). If they don't, give them the boot! If they do, then we store a copy of the session data (yay we have access!) in the client object and then setup the rest of the socket events. Finally, send them a welcome message just to prove that we remembered their profile. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>helper function that goes inside your socket connection</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">client</span><span class="p">.</span><span class="nx">connectSession</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">client</span><span class="p">.</span><span class="nx">request</span> <span class="o">||</span> <span class="o">!</span><span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="o">!</span><span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">disconnectAndRedirectClient</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Null request/header/cookie!&#39;</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Cookie is&#39;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">sid</span><span class="p">;</span>

        <span class="nx">match</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/connect\.sid=([^;]+)/</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span> <span class="o">||</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">disconnectAndRedirectClient</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Failed to find connect.sid in cookie&#39;</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">sid</span> <span class="o">=</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="nx">rc</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">connectSession</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Error on connectionSession: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">connectedUser</span> <span class="o">=</span> <span class="nx">getConnectedUser</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">client</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">connectedUser</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">message</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">sendInitialDataToClient</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Failed to connect user&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>


<span class="kd">function</span> <span class="nx">sendInitialDataToClient</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chatHistory</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">chatHistory</span> <span class="o">=</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">rest</span><span class="p">(</span><span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">100</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>  <span class="p">{</span>
        <span class="nx">chatHistory</span> <span class="o">=</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;sending &#39;</span> <span class="o">+</span> <span class="nx">chatHistory</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

    <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)});</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;user:add&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">sUser</span><span class="p">.</span><span class="nx">xport</span><span class="p">()</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">chatHistory</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">chat</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;chat&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">()</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">globalMashTags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;globalmashtag&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">broadcastChat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">chat</span><span class="p">);</span>

    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span> <span class="o">+</span> <span class="s1">&#39;] &#39;</span> <span class="o">+</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">());</span>

    <span class="nx">rc</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;chatentries&#39;</span><span class="p">,</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">}),</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">);</span>

    <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({</span>
        <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;chat&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span><span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">()</span>
    <span class="p">});</span> 
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Handles MashTag creation and notification
TODO - refactor to use CPS</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">handleMashTags</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[handleMashTags] user is null&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">mashTags</span> <span class="o">=</span> <span class="nx">mashlib</span><span class="p">.</span><span class="nx">getChunksFromString</span><span class="p">(</span><span class="nx">chat</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mashTags</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">alreadyNotifiedUsers</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span> <span class="c1">//Make sure we only send a multi-tagged chat once</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">mashTags</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">foundTag</span> <span class="o">=</span> <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">globalMashTags</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">mashTags</span><span class="p">[</span><span class="nx">t</span><span class="p">];});</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Create a new mashTag if we need to</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">foundTag</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">createTag</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">rc</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s1">&#39;next.mashtag.id&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newMashId</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">foundTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">models</span><span class="p">.</span><span class="nx">MashTagModel</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="nx">newMashId</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span> <span class="nx">tagName</span><span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Add the tag to the global list, the users list (since they submitted it), and the chat message. Then add subcribe the user
to the mash tag.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">nodeChatModel</span><span class="p">.</span><span class="nx">globalMashTags</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">foundTag</span><span class="p">);</span>
                        <span class="nx">foundTag</span><span class="p">.</span><span class="nx">watchingUsers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>

                        <span class="nx">addMashTagToStore</span><span class="p">(</span><span class="nx">foundTag</span><span class="p">);</span>
                        <span class="nx">sendMashTagsToUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">foundTag</span><span class="p">);</span>
                        <span class="nx">broadcastGlobalMashTag</span><span class="p">(</span><span class="nx">foundTag</span><span class="p">);</span>
                        <span class="nx">saveMashtagForUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">foundTag</span><span class="p">);</span>

                        <span class="nx">notifySubscribedMashTagUsers</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span><span class="nx">foundTag</span><span class="p">,</span> <span class="nx">alreadyNotifiedUsers</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">};</span>
                <span class="nx">createTag</span><span class="p">(</span><span class="nx">mashTags</span><span class="p">[</span><span class="nx">t</span><span class="p">]);</span>
            <span class="p">}</span> 
            <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>In the case the tag exists, check to see if the submitting user is watching it</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">foundTag</span><span class="p">.</span><span class="nx">watchingUsers</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">u</span> <span class="o">===</span> <span class="nx">user</span><span class="p">;</span> <span class="p">}))</span> <span class="p">{</span> 
                    <span class="nx">foundTag</span><span class="p">.</span><span class="nx">watchingUsers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>

                    <span class="nx">sendMashTagsToUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">foundTag</span><span class="p">);</span>
                    <span class="nx">saveMashtagForUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">foundTag</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Notify all the subscribed users</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">notifySubscribedMashTagUsers</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">foundTag</span><span class="p">,</span> <span class="nx">alreadyNotifiedUsers</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">addMashTagToStore</span><span class="p">(</span><span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[addMashTagToStore] called without valid tag.&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">rKey</span> <span class="o">=</span> <span class="s1">&#39;mashtags&#39;</span><span class="p">;</span>

    <span class="nx">rc</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="nx">rKey</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">}),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[addMashTagToStore] SADD failed for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[addMashTagToStore] SADD succeeded for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span><span class="p">);</span> 
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Helper function to persist a tag subscription for a user</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">saveMashtagForUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;[saveMashtagForUser] called without valid tag.&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">rKey</span> <span class="o">=</span> <span class="s1">&#39;user:&#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mashtags&#39;</span><span class="p">;</span>

    <span class="nx">rc</span><span class="p">.</span><span class="nx">sismember</span><span class="p">(</span><span class="nx">rKey</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;SISMEMBER failed for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span> <span class="o">+</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">rc</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="nx">rKey</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;SADD failed for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span> <span class="o">+</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="k">else</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;SADD succeeded for key: &#39;</span> <span class="o">+</span> <span class="nx">rKey</span> <span class="o">+</span> <span class="s1">&#39; and value: &#39;</span> <span class="o">+</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Value: &#39;</span> <span class="o">+</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; already exists for key: &#39;</span><span class="o">+</span> <span class="nx">rKey</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Helper function to send tags to a user</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">broadcastGlobalMashTag</span><span class="p">(</span><span class="nx">mashTag</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({</span>
        <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;globalmashtag&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">mashTag</span><span class="p">.</span><span class="nx">xport</span><span class="p">({</span><span class="nx">recurse</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Send the chat to all currently subscribed users for a mashTag</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">notifySubscribedMashTagUsers</span><span class="p">(</span><span class="nx">chat</span><span class="p">,</span> <span class="nx">mashTag</span><span class="p">,</span> <span class="nx">doNotNotifyList</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mashTag</span><span class="p">.</span><span class="nx">watchingUsers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">doNotNotifyList</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)])</span> <span class="k">return</span><span class="p">;</span>

        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[notifySubscribedMashTagUsers] notifying user: &#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; for chat: &#39;</span> <span class="o">+</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">());</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">clientList</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;[notifySubscribedMashTagUsers] client send for user: &#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; for client: &#39;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
                <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;mash&#39;</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">xport</span><span class="p">()</span>
            <span class="p">});</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Add the user to do not call list so they only get one copy</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">doNotNotifyList</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Open a config file (currently empty) to see if we are on a server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">path</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">config_file</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Attempting to use config at &#39;</span> <span class="o">+</span> <span class="nx">config_file</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;no config found. starting in local dev mode&#39;</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">dev_port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">dev_port</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Hack, delete the old css. For some reason the middleware is not recompiling</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="s1">&#39;./public/main.css&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Unlink failed for ./public/main.css: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="k">else</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Unlinked ./public/main.css&#39;</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
          <span class="nx">port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
          <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/main.css&#39;</span>
        <span class="p">}</span>

        <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span><span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;GET main.css complete&#39;</span><span class="p">)});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;config found. starting in server mode&#39;</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server_port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">server_port</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;listening on port &#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>

    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">restrict</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">locals</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">hash</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 